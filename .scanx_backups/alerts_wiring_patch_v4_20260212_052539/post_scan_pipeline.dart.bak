import 'package:flutter/material.dart';
import 'package:scanx_app/core/services/scan_service.dart';
import 'package:scanx_app/core/services/scan_snapshot_store.dart';
import 'package:scanx_app/core/services/alert_rules_engine.dart';
import 'package:scanx_app/core/services/in_app_notifier.dart';
import 'package:scanx_app/core/services/settings_service.dart';
import 'package:scanx_app/features/router/router_iot_security.dart';

class PostScanPipeline {
  static Future<void> handleScanComplete(
    BuildContext context, {
    required ScanResult result,
    required bool isAutoScan,
  }) async {
    final store = ScanSnapshotStore();
    final previous = await store.load();
    final ipToMac = await store.getIpToMacBestEffort();

    final events = AlertRulesEngine().buildEvents(
      current: result,
      previousSnapshot: previous,
      currentIpToMac: ipToMac,
    );

// Router/IoT alert events (gated by Alerts toggles).
// Advisory signals derived from RouterIotSecurityService summary.
final s = SettingsService();
final routerIot = RouterIotSecurityService();
final summary = routerIot.buildSummary(detectedHosts);

if (s.notifyRouterVuln) {
  final hasRouterHigh = summary.issues.any((i) => i.isHighSeverity);
  if (hasRouterHigh) {
    events.add(AlertEvent(
      type: AlertType.routerVulnerability,
      severity: AlertSeverity.high,
      title: 'Router vulnerability',
      detail: 'Router security issues detected (see Router & IoT tab).',
    ));
  }
}

if (s.notifyIotWarning) {
  if (summary.highRiskIotDevices > 0 || summary.mediumRiskIotDevices > 0) {
    events.add(AlertEvent(
      type: AlertType.iotWarning,
      severity: summary.highRiskIotDevices > 0 ? AlertSeverity.high : AlertSeverity.medium,
      title: 'IoT warning',
      detail: 'IoT device risks detected (see Router & IoT tab).',
    ));
  }
}

    await store.save(result: result, ipToMac: ipToMac);
    if (!context.mounted) return;

    await InAppNotifier().notify(context, events, isAutoScan: isAutoScan);
  }
}